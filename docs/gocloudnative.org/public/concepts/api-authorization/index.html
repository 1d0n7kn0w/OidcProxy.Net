<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Read how to implement OAuth2/OIDC in a aspnetcore C# application.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="API Authorization with OAuth2/OpenId Connect" />
<meta property="og:description" content="Read how to implement OAuth2/OIDC in a aspnetcore C# application." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gocloudnative.org/concepts/api-authorization/" /><meta property="article:section" content="concepts" />


<title>API Authorization with OAuth2/OpenId Connect | GoCloudNative.org/bff</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css" integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz&#43;OQteg=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.b940f5e50340290d31079ccfa3fd9e66673165d1dcd8f9de1e473ba1a1bccc5d.js" integrity="sha256-uUD15QNAKQ0xB5zPo/2eZmcxZdHc2PneHkc7oaG8zF0=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>GoCloudNative.org/bff</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  
















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>API Authorization with OAuth2/OpenId Connect</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#implications">Implications</a>
      <ul>
        <li><a href="#identity-and-access-management">Identity and Access Management</a></li>
        <li><a href="#pii">PII</a></li>
      </ul>
    </li>
    <li><a href="#how-to-implement-authorization-in-your-api">How to implement authorization in your API</a></li>
    <li><a href="#advanced-authorization-scenarios">Advanced authorization scenario&rsquo;s</a>
      <ul>
        <li><a href="#even-more-advanced-scenarios">Even more advanced scenario&rsquo;s</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#sources">Sources</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="api-authorization-with-oauth2openid-connect">
  API Authorization with OAuth2/OpenId Connect
  <a class="anchor" href="#api-authorization-with-oauth2openid-connect">#</a>
</h1>
<p>OAuth2 is an authorization protocol. It is meant to be used to grant or deny access to resources. OpenId Connect extends the OAuth2 protocol. OpenId Connect (OIDC) is an identity protocol. It emits the identity of either a person or a machine.</p>
<p>An important aspect of both OAuth2 and OIDC is that both protocols authenticate a person decentrally. This allows the application landscape which uses an OAuth2- or an OIDC-server to scale.</p>
<p>To get the benefits that go with decentralized authentication, there are certain concepts to keep in mind when you&rsquo;re implementing authorization in an API:</p>
<ol>
<li>Use the OIDC-server for authentication purposes</li>
<li>Make sure the OIDC-server is application agnostic</li>
<li>Apply policies</li>
<li>Do not store Personal Identifyable Information in your APIs</li>
</ol>
<h2 id="implications">
  Implications
  <a class="anchor" href="#implications">#</a>
</h2>
<p>The OpenId Connect protocol is built in such a way that it solves a number of common authentication- and authorization problems. If you want to profit from this, keep in mind the following things when you implement authorization in your API:</p>
<h3 id="identity-and-access-management">
  Identity and Access Management
  <a class="anchor" href="#identity-and-access-management">#</a>
</h3>
<p>Implementing authorization in an API is means to an end. When you are implementing OIDC-based authentication, you&rsquo;re delegating the responsibility to authenticate users to another application.</p>
<p>Delegating this responsiblity comes with a risk. The more the OIDC-server &ldquo;knows&rdquo; about another application, the harder it gets to release the two. Also, when more application&rsquo;s are &lsquo;born&rsquo;, the OIDC-server will have to store more and more data. This does not scale well.</p>
<p>Therefor, as a common rule of thumb, try to reduce what the OIDC-server knows about other applications to a minimum. Stick to common OIDC-claims as much as you can.</p>
<p><em>Example: Common scenario&rsquo;s to avoid:</em></p>
<ul>
<li><em>Implementing application-specific roles like &ldquo;crm_admin&rdquo;</em></li>
<li><em>Creating application-specific claims like &ldquo;is_crm_admin&rdquo;</em></li>
<li><em>And so forth</em></li>
</ul>
<p><em>Examples: Instead do this:</em></p>
<ul>
<li><em>role: &ldquo;hr_secretary&rdquo;, applications may decide what authorization applies for users in such a role.</em></li>
</ul>
<h3 id="pii">
  PII
  <a class="anchor" href="#pii">#</a>
</h3>
<p>An OIDC server exchanges identity-information with an application through access- and id-tokens. These tokens contain Personal Identifyable Information. When the front-end uses the id_token to display a user&rsquo;s name, for example, and when the back-end uses nothing but roles, user-ids, and scopes, then there is no need for an API to store Personal Identifyable Information.</p>
<p>As a result, Personal Identifyable Information is always in one place: The OIDC Server. This is very convenient when you want to be GDPR-compliant.</p>
<h2 id="how-to-implement-authorization-in-your-api">
  How to implement authorization in your API
  <a class="anchor" href="#how-to-implement-authorization-in-your-api">#</a>
</h2>
<p>So, to implement authorization in a scalable, safe way, make sure to do the following:</p>
<ul>
<li>Do not include the <code>id_token</code> in API requests</li>
<li>Include the <code>access_token</code> in the request to an API</li>
<li>Use the information int he <code>access_token</code> to apply a <code>policy</code>.</li>
<li>Do not build your own authorization middleware, instead use <code>Microsoft.AspNetCore.Authentication</code>.</li>
</ul>
<p>Given an API does not have a user interface, it does not care how the consumer of the API obtained an <code>access_token</code>. All it should care about is if it is a valid token. So, in your <code>program.cs</code>, implement the following code:</p>
<p>.NET 6:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.AspNetCore.Authentication.JwtBearer;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.IdentityModel.Tokens;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> builder = WebApplication.CreateBuilder(args);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
</span></span><span style="display:flex;"><span>    .AddJwtBearer(<span style="color:#e6db74">&#34;Bearer&#34;</span>, options =&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        options.Authority = <span style="color:#e6db74">&#34;https://login.yourdomain.com&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        options.TokenValidationParameters = <span style="color:#66d9ef">new</span> TokenValidationParameters
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//..</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> app = builder.Build();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app.UseAuthorization();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app.Run();
</span></span></code></pre></div><p>And decorate the endpoints in your controllers as such:</p>
<p>.NET 6:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[ApiController]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[Route(&#34;api/test&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WeatherForecastController</span> : ControllerBase
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [HttpGet]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Authorize]</span> <span style="color:#75715e">// Use this attribute to enforce authentication</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IActionResult Get()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> user = <span style="color:#66d9ef">this</span>.User.Identity <span style="color:#66d9ef">as</span> ClaimsIdentity;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Ok(<span style="color:#e6db74">$&#34;Hello, {user.Name}!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Find a sample implementation <a href="https://github.com/thecloudnativewebapp/GoCloudNative.Bff/blob/main/docs/Integration-Manuals/Integrating-With-Identity-Providers/IdentityServer4/src/Api/Program.cs">here</a>.</p>
<h2 id="advanced-authorization-scenarios">
  Advanced authorization scenario&rsquo;s
  <a class="anchor" href="#advanced-authorization-scenarios">#</a>
</h2>
<p>Sometimes, the information stored in the <code>access_token</code> is not sufficient to determine whether someone is authorized to access a resource or not. In that case, you need to enritch the context, so you can apply a policy on the information from the <code>access_token</code> combined with application specific information.</p>
<p>Enritching the context as such is called claims-transformation. This can be applied by implementing the <code>IClaimsTransformation</code> interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.AspNetCore.Authentication;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Security.Claims;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyClaimsTransformation</span> : IClaimsTransformation
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Task&lt;ClaimsPrincipal&gt; TransformAsync(ClaimsPrincipal principal)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ClaimsIdentity claimsIdentity = <span style="color:#66d9ef">new</span> ClaimsIdentity();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> claimType = <span style="color:#e6db74">&#34;myNewClaim&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (!principal.HasClaim(claim =&gt; claim.Type == claimType))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            claimsIdentity.AddClaim(<span style="color:#66d9ef">new</span> Claim(claimType, <span style="color:#e6db74">&#34;myClaimValue&#34;</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        principal.AddIdentity(claimsIdentity);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Task.FromResult(principal);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Register the middleware in <code>program.cs</code> as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>builder.Services.AddTransient&lt;IClaimsTransformation, MyClaimsTransformation&gt;();
</span></span></code></pre></div><p>To apply a custom policy on this claim, implement policy-based authorization by adding the following code-snippet to <code>program.cs</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>builder.Services.AddAuthorization(o =&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    o.AddPolicy(<span style="color:#e6db74">&#34;onlyMyNewClaim&#34;</span>, p =&gt; p.RequireClaim(<span style="color:#e6db74">&#34;myNewClaim&#34;</span>, <span style="color:#e6db74">&#34;myClaimValue&#34;</span>));
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>And apply the policy in your controller:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[HttpGet]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[Authorize(&#34;onlyMyNewClaim&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> IActionResult Get()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Ok(<span style="color:#e6db74">&#34;I am authorized!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="even-more-advanced-scenarios">
  Even more advanced scenario&rsquo;s
  <a class="anchor" href="#even-more-advanced-scenarios">#</a>
</h3>
<p>As an alternative you may consider implementing <a href="https://www.openpolicyagent.org/">Open Policy Agent</a>.</p>
<h2 id="summary">
  Summary
  <a class="anchor" href="#summary">#</a>
</h2>
<p>Use OpenId for authentication-purposes. Apply a policy in each individual API to determine whether or not the consumer of the API is authorized.</p>
<h2 id="sources">
  Sources
  <a class="anchor" href="#sources">#</a>
</h2>
<ul>
<li><a href="https://abstarreveld.medium.com/claims-transformation-in-net-6-483c30705e12">https://abstarreveld.medium.com/claims-transformation-in-net-6-483c30705e12</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/claims?view=aspnetcore-6.0#extend-or-add-custom-claims-using-iclaimstransformationcore-6.0">https://learn.microsoft.com/en-us/aspnet/core/security/authentication/claims?view=aspnetcore-6.0#extend-or-add-custom-claims-using-iclaimstransformationcore-6.0</a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/policies?view=aspnetcore-7.0">https://learn.microsoft.com/en-us/aspnet/core/security/authorization/policies?view=aspnetcore-7.0</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#implications">Implications</a>
      <ul>
        <li><a href="#identity-and-access-management">Identity and Access Management</a></li>
        <li><a href="#pii">PII</a></li>
      </ul>
    </li>
    <li><a href="#how-to-implement-authorization-in-your-api">How to implement authorization in your API</a></li>
    <li><a href="#advanced-authorization-scenarios">Advanced authorization scenario&rsquo;s</a>
      <ul>
        <li><a href="#even-more-advanced-scenarios">Even more advanced scenario&rsquo;s</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#sources">Sources</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












